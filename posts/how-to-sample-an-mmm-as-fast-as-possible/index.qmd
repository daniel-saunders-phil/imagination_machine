---
title: "How to sample a mmm as fast as possible"
author: Daniel Saunders
jupyter: python3
date: 
toc: true
description: "And learn about HMC's mass matrix along the way."
execute:
  echo: false
format:
  html:
    code-fold: true
image: 
---

# Dude, where's my samples?

```{python}
import numpy as np
import pymc as pm
import matplotlib.pyplot as plt
import nutpie
from scipy import stats
import arviz as az

def saturation(x,b,c):
    return b * ((1 - np.exp(-c*x)) / (1 + np.exp(-c*x)))

f, ax = plt.subplots(1,2,figsize=(12,4))

x = np.linspace(0,2,50)

b = 0.7
c = 3

np.random.seed(42)

mu = saturation(x=x,b=b,c=c)
y = np.random.normal(loc=mu,scale=0.05)
ax[0].plot(x,mu,color='tab:blue')
ax[0].plot(x,y,'o',color="tab:cyan")
ax[0].set_xlabel("Marketing spend")
ax[0].set_ylabel("Sales")

bs = np.linspace(0,1,100)
cs = np.linspace(0,4,100)

B, C = np.meshgrid(bs,cs)

xs = np.expand_dims(x,axis=(1,2))

mu = saturation(x=xs,b=B,c=C)
ys = np.expand_dims(y,axis=(1,2))

likelihood_surface = stats.norm(loc=mu,scale=0.05).logpdf(ys).sum(axis=0)

ax[1].contour(B,C,likelihood_surface,levels=40)
ax[1].plot(b,c,'o')
ax[1].annotate("true parameter value", (b,c), xytext=(10,10), textcoords='offset points', fontsize=8)
ax[1].set_xlabel("b (saturation point)")
ax[1].set_ylabel("lam (efficiency)")
plt.colorbar(mappable=ax[1].collections[0], ax=ax[1], label='Log Likelihood');
f.suptitle("Likelihood surface for logistic saturation function");
```

```{python}
#| echo: true
with pm.Model() as m0:
    b = pm.Uniform('saturation_point',lower=0,upper=2)
    c = pm.Uniform("efficiency",lower=0.01,upper=4)
    sigma = pm.Exponential("sigma",scale=1)
    marketing_effect = saturation(x,b=b,c=c)
    sales = pm.Normal('sales',mu=marketing_effect,sigma=sigma,observed=y)

compiled_model = nutpie.compile_pymc_model(m0)
```

```{python}
trace_diagonal = nutpie.sample(
    compiled_model,
    chains=1,
    draws=10_000,
    low_rank_modified_mass_matrix=False,
    progress)

ess_table = az.ess(trace_diagonal)[["efficiency","saturation_point"]]
print("\nEffective Sample Size (ESS) Statistics:")
print("=====================================")
print(f"Efficiency ESS:        {ess_table['efficiency']:,.0f} / 10,000")
print(f"Saturation Point ESS:  {ess_table['saturation_point']:,.0f} / 10,000")
```

# What's a mass matrix?

{{< video hmc_on_differing_variance_mvnormal.gif >}}

# Dude, here's your samples